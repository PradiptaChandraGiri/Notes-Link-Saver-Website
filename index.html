<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Notes Link Saver ‚Äî PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />

  <!-- Theme color (updated dynamically) -->
  <meta name="theme-color" content="#4f46e5" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <style>
    body::-webkit-scrollbar { width: 8px; }

    /* Default Light Input Style */
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(156,163,175,.5);
      background: #f8fafc;
      color: #111827;
      transition: .2s;
    }

    .form-input:focus {
      border-color: rgba(79,70,229,0.9);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
    }

    /* DARK MODE INPUT FIX (Very Important) */
    .dark .form-input {
      background: #1f2937;
      border-color: #374151;
      color: #f9fafb;
    }
    .dark .form-input::placeholder {
      color: #9ca3af;
    }

    .offline-badge { background:#ef4444; color:white; }
    .online-badge  { background:#10b981; color:white; }

    :root, .dark {
      transition: background-color 200ms ease, color 200ms ease;
    }
  </style>

  <!-- Instant Theme Load (prevents flash on reload) -->
  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const useDark = saved === 'dark' || (!saved && prefersDark);

      if (useDark) {
        document.documentElement.classList.add('dark');
        document.querySelector('meta[name="theme-color"]')
              ?.setAttribute('content', '#0b1220');
      } else {
        document.documentElement.classList.remove('dark');
        document.querySelector('meta[name="theme-color"]')
              ?.setAttribute('content', '#4f46e5');
      }
    })();
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans min-h-screen">
  <div class="container mx-auto p-4 lg:p-8">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400">üìö Daily Notes Link Saver (PWA)</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Save links, sync across devices, work offline.</p>
      </div>

      <div class="flex items-center space-x-3">
        <span id="sync-indicator" class="px-3 py-1 rounded-full text-sm online-badge">Checking...</span>

        <button id="manual-sync"
                class="px-3 py-1 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2">
          Sync Now
        </button>

        <!-- Theme toggle: label set by JS -->
        <button id="theme-toggle"
                aria-label="Toggle theme"
                title="Toggle light / dark theme"
                class="px-3 py-1 rounded-lg bg-gray-200 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 theme-btn">
          <!-- JS will write "üåô Dark" or "‚òÄÔ∏è Light" -->
        </button>

        <p id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400"></p>
      </div>
    </header>

    <!-- Main grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form column -->
      <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
        <h2 id="form-header" class="text-xl font-bold mb-4">Add New Note</h2>

        <form id="note-form" class="space-y-3" autocomplete="off">
          <input type="hidden" id="note-id" value="">

          <div>
            <label for="subject" class="text-sm font-medium block mb-1">Subject</label>
            <input id="subject" list="subject-suggestions" class="form-input" placeholder="e.g., Data Structures" required />
            <datalist id="subject-suggestions"></datalist>
          </div>

          <div>
            <label for="title" class="text-sm font-medium block mb-1">Title</label>
            <input id="title" class="form-input" placeholder="Optional title" />
          </div>

          <div>
            <label for="url" class="text-sm font-medium block mb-1">URL</label>
            <input id="url" type="url" class="form-input" placeholder="https://..." required />
            <button type="button" id="ai-insight-button" class="mt-2 px-3 py-2 bg-purple-600 text-white rounded-lg w-full hover:bg-purple-700 focus:outline-none">
              ‚ú® Get AI Title
            </button>
          </div>

          <div class="flex gap-2">
            <button id="save-button" type="submit" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none">
              üíæ Save Note
            </button>
            <button id="cancel-edit-button" type="button" class="hidden flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 focus:outline-none">
              Cancel
            </button>
          </div>

          <p id="form-message" class="text-sm mt-2"></p>
        </form>
      </div>

      <!-- Notes list column -->
      <div class="lg:col-span-2 space-y-4">
        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow">
          <h2 class="text-xl font-bold">All Saved Notes</h2>

          <div class="flex gap-3 mt-3 flex-col sm:flex-row">
            <input id="search-input" placeholder="Search..." class="form-input" aria-label="Search notes" />
            <select id="filter-subject" class="form-input w-48" aria-label="Filter by subject">
              <option value="">All Subjects</option>
            </select>
            <select id="sort-by" class="form-input w-40" aria-label="Sort notes">
              <option value="date_desc">Newest First</option>
              <option value="date_asc">Oldest First</option>
              <option value="subject_asc">Subject (A-Z)</option>
            </select>
          </div>
        </div>

        <div id="notes-list" class="space-y-3" aria-live="polite">
          <p id="loading-message" class="text-center py-8 text-gray-500 dark:text-gray-400">Starting up...</p>
          <p id="no-notes-message" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">No notes yet.</p>
          <!-- note items injected here -->
        </div>
      </div>
    </div>
  </div>
<!-- =======================  APP LOGIC  ======================= -->
<script type="module">

/* ============================================================
   CONFIG + DOM ELEMENTS
============================================================ */
const appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
const firebaseConfig = JSON.parse(
  typeof __firebase_config !== "undefined" ? __firebase_config : "{}"
);
const initialAuthToken =
  typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;

/* DOM refs */
const loadingMessage = document.getElementById("loading-message");
const noNotesMessage = document.getElementById("no-notes-message");
const notesList = document.getElementById("notes-list");
const subjectSuggestions = document.getElementById("subject-suggestions");

const filterSubject = document.getElementById("filter-subject");
const sortBy = document.getElementById("sort-by");
const searchInput = document.getElementById("search-input");

const saveButton = document.getElementById("save-button");
const cancelEditButton = document.getElementById("cancel-edit-button");
const formHeader = document.getElementById("form-header");

const aiButton = document.getElementById("ai-insight-button");
const titleInput = document.getElementById("title");
const urlInput = document.getElementById("url");

const manualSyncBtn = document.getElementById("manual-sync");
const syncIndicator = document.getElementById("sync-indicator");
const userIdDisplay = document.getElementById("user-id-display");

const themeToggleBtn = document.getElementById("theme-toggle");

/* Globals */
let db = null;
let auth = null;
let userId = "";
let notesListenerUnsub = null;

let allNotes = [];
let allSubjects = new Set();

const LOCAL_KEY = "daily_notes_local_v1";
const SYNC_QUEUE_KEY = "daily_notes_sync_queue_v1";

/* ============================================================
   THEME HANDLING
============================================================ */
function applyTheme(theme) {
  const meta = document.querySelector("meta[name='theme-color']");

  if (theme === "dark") {
    document.documentElement.classList.add("dark");
    localStorage.setItem("theme", "dark");
    themeToggleBtn.innerHTML = "‚òÄÔ∏è Light";

    if (meta) meta.setAttribute("content", "#0b1220");
  } else {
    document.documentElement.classList.remove("dark");
    localStorage.setItem("theme", "light");
    themeToggleBtn.innerHTML = "üåô Dark";

    if (meta) meta.setAttribute("content", "#4f46e5");
  }
}

/* initialize theme button text */
(function initTheme() {
  const saved = localStorage.getItem("theme");
  const prefersDark =
    window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: dark)").matches;

  const finalTheme = saved || (prefersDark ? "dark" : "light");
  applyTheme(finalTheme);
})();

themeToggleBtn.addEventListener("click", () => {
  const isDark = document.documentElement.classList.contains("dark");
  applyTheme(isDark ? "light" : "dark");
});

/* ============================================================
   FIREBASE INIT
============================================================ */
if (Object.keys(firebaseConfig).length > 0) {
  try {
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore(app);
    auth = firebase.auth(app);
    console.log("Firebase connected.");
  } catch (e) {
    console.error("Firebase init failed:", e);
    db = null;
    loadingMessage.textContent = "Firebase error ‚Äî working locally.";
  }
} else {
  console.warn("Missing Firebase config ‚Äî local-only mode.");
  db = null;
  loadingMessage.textContent =
    "No Firebase config. Using offline/local mode only.";
}

/* ============================================================
   LOCAL STORAGE HELPERS
============================================================ */
function loadLocalNotes() {
  try {
    const raw = localStorage.getItem(LOCAL_KEY);
    if (!raw) return [];

    return JSON.parse(raw).map((n) => ({
      ...n,
      created_at: n.created_at ? new Date(n.created_at) : new Date(),
    }));
  } catch (e) {
    console.error("loadLocalNotes() failed:", e);
    return [];
  }
}

function saveLocalNotes(notes) {
  try {
    const formatted = notes.map((n) => ({
      ...n,
      created_at:
        n.created_at instanceof Date ? n.created_at.toISOString() : n.created_at,
    }));
    localStorage.setItem(LOCAL_KEY, JSON.stringify(formatted));
  } catch (e) {
    console.error("saveLocalNotes() failed:", e);
  }
}

/* Sync queue (offline changes ‚Üí cloud later) */
function loadSyncQueue() {
  try {
    return JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || "[]");
  } catch {
    return [];
  }
}
function saveSyncQueue(q) {
  localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(q));
}

/* ============================================================
   CLOUD MERGE: LWW (latest timestamp wins)
============================================================ */
function mergeNotes(localNotes, cloudNotes) {
  const map = new Map();

  [...localNotes, ...cloudNotes].forEach((n) => {
    const id = n.id || n.local_id;
    if (!id) return;

    const prev = map.get(id);
    if (!prev) return map.set(id, n);

    const prevT = new Date(prev.created_at).getTime();
    const newT = new Date(n.created_at).getTime();

    if (newT >= prevT) map.set(id, n);
  });

  return [...map.values()];
}

/* ============================================================
   FIRESTORE: SAFE WRAPPERS
============================================================ */
function colRef(uid) {
  if (!db) return null;
  return db.collection(`artifacts/${appId}/users/${uid}/daily_notes`);
}

async function pushQueue(uid) {
  if (!db) return;

  const queue = loadSyncQueue();
  if (queue.length === 0) return;

  const ref = colRef(uid);
  if (!ref) return;

  const remaining = [];

  for (const item of queue) {
    try {
      if (item.action === "delete" && item.remoteId) {
        await ref.doc(item.remoteId).delete();
        continue;
      }

      if (item.remoteId) {
        await ref.doc(item.remoteId).set(
          {
            subject: item.subject,
            title: item.title,
            url: item.url,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
          },
          { merge: true }
        );
      } else {
        const res = await ref.add({
          subject: item.subject,
          title: item.title,
          url: item.url,
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
        });
        item.remoteId = res.id;
      }
    } catch {
      remaining.push(item);
    }
  }

  saveSyncQueue(remaining);

  if (!remaining.length) {
    displayMessage("All offline changes synced.", "success");
  }
}

/* ============================================================
   LIVE CLOUD LISTENER
============================================================ */
function setupListener(uid) {
  if (!db) return;

  const ref = colRef(uid);
  if (!ref) return;

  if (notesListenerUnsub) notesListenerUnsub();

  notesListenerUnsub = ref.onSnapshot(
    (snap) => {
      const cloudNotes = snap.docs.map((doc) => {
        const d = doc.data();
        return {
          id: doc.id,
          subject: d.subject,
          title: d.title,
          url: d.url,
          created_at: d.created_at ? d.created_at.toDate() : new Date(),
        };
      });

      const localNotes = loadLocalNotes();
      const merged = mergeNotes(localNotes, cloudNotes);

      saveLocalNotes(merged);
      allNotes = merged;

      allSubjects = new Set(allNotes.map((n) => n.subject));
      updateSubjectSuggestions();
      updateSubjectFilter();
      renderNotes();

      loadingMessage.classList.add("hidden");
    },
    () => {
      loadingMessage.textContent = "Cloud sync error.";
    }
  );
}

/* ============================================================
   SYNC INDICATOR
============================================================ */
function setIndicator(state) {
  switch (state) {
    case "offline":
      syncIndicator.textContent = "Offline";
      syncIndicator.className = "px-3 py-1 rounded-full text-sm offline-badge";
      break;

    case "syncing":
      syncIndicator.textContent = "Syncing‚Ä¶";
      syncIndicator.className =
        "px-3 py-1 rounded-full text-sm bg-yellow-400 text-black";
      break;

    case "online":
      syncIndicator.textContent = "Online & Synced";
      syncIndicator.className = "px-3 py-1 rounded-full text-sm online-badge";
      break;

    case "local":
      syncIndicator.textContent = "Online (Local only)";
      syncIndicator.className =
        "px-3 py-1 rounded-full text-sm bg-orange-500 text-white";
      break;
  }
}

window.addEventListener("online", async () => {
  setIndicator("syncing");
  if (db && auth && userId) {
    await pushQueue(userId);
    setIndicator("online");
  } else setIndicator("local");
});
window.addEventListener("offline", () => setIndicator("offline"));

/* ============================================================
   UI UPDATES + RENDERING
============================================================ */
function updateSubjectSuggestions() {
  subjectSuggestions.innerHTML = "";
  [...allSubjects].sort().forEach((s) => {
    const opt = document.createElement("option");
    opt.value = s;
    subjectSuggestions.appendChild(opt);
  });
}

function updateSubjectFilter() {
  const current = filterSubject.value;
  filterSubject.innerHTML = '<option value="">All Subjects</option>';

  [...allSubjects].sort().forEach((s) => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    filterSubject.appendChild(opt);
  });

  filterSubject.value = current;
}

function escapeHtml(t = "") {
  return t.replace(/[&<>"']/g, (c) =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
  );
}

function renderNotes() {
  const q = searchInput.value.trim().toLowerCase();
  const sub = filterSubject.value;
  const sort = sortBy.value;

  let notes = allNotes.filter((n) => {
    const m1 = !sub || n.subject === sub;
    const m2 =
      !q ||
      n.subject.toLowerCase().includes(q) ||
      n.title.toLowerCase().includes(q);
    return m1 && m2;
  });

  notes.sort((a, b) => {
    if (sort === "subject_asc")
      return a.subject.localeCompare(b.subject);

    const ta = new Date(a.created_at).getTime();
    const tb = new Date(b.created_at).getTime();
    return sort === "date_asc" ? ta - tb : tb - ta;
  });

  notesList.innerHTML = "";
  if (!notes.length) {
    noNotesMessage.classList.remove("hidden");
    return;
  }
  noNotesMessage.classList.add("hidden");

  notes.forEach((n) => {
    const card = document.createElement("div");
    card.className =
      "p-4 bg-white dark:bg-gray-800 rounded-lg shadow flex justify-between items-start";

    card.innerHTML = `
      <div>
        <div class="text-sm font-semibold text-indigo-600 dark:text-indigo-400">${escapeHtml(
          n.subject
        )}</div>
        <div class="text-lg font-bold">
          <a href="${escapeHtml(n.url)}" target="_blank" class="hover:underline">
            ${escapeHtml(n.title || "No Title")}
          </a>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Saved: ${n.created_at.toLocaleString()}
        </div>
      </div>

      <div>
        <button class="mr-2 edit-btn">‚úèÔ∏è</button>
        <button class="del-btn">üóëÔ∏è</button>
      </div>
    `;

    card.querySelector(".edit-btn").onclick = () => startEdit(n);
    card.querySelector(".del-btn").onclick = () => deleteNote(n);

    notesList.appendChild(card);
  });
}

/* ============================================================
   CRUD OPERATIONS
============================================================ */
function cryptoId() {
  return "l_" + Math.random().toString(36).slice(2, 10) + Date.now();
}

async function saveNote(evt) {
  evt.preventDefault();

  const subject = document.getElementById("subject").value.trim();
  const title = titleInput.value.trim() || "No Title";
  let url = urlInput.value.trim();

  if (!subject || !url) {
    displayMessage("Subject and URL required.", "error");
    return;
  }
  if (!url.startsWith("http")) url = "https://" + url;

  const editingId = document.getElementById("note-id").value || null;

  const note = {
    subject,
    title,
    url,
    local_id: editingId || cryptoId(),
    created_at: new Date(),
  };

  let local = loadLocalNotes();

  if (editingId) {
    local = local.map((n) =>
      n.local_id === editingId || n.id === editingId
        ? { ...n, subject, title, url }
        : n
    );
  } else {
    local.unshift(note);
  }

  saveLocalNotes(local);
  allNotes = local;

  allSubjects = new Set(local.map((n) => n.subject));
  updateSubjectSuggestions();
  updateSubjectFilter();
  renderNotes();

  /* queue for cloud sync */
  const queue = loadSyncQueue();
  const existing = queue.find((i) => i.local_id === note.local_id);

  if (existing) {
    existing.subject = subject;
    existing.title = title;
    existing.url = url;
  } else {
    queue.push({
      local_id: note.local_id,
      subject,
      title,
      url,
      remoteId: null,
    });
  }
  saveSyncQueue(queue);

  resetForm();
  displayMessage("Saved locally. Will sync online.", "success");

  if (navigator.onLine && db && auth && userId) {
    await pushQueue(userId);
  }
}

function startEdit(n) {
  document.getElementById("note-id").value = n.id || n.local_id;
  document.getElementById("subject").value = n.subject;
  titleInput.value = n.title === "No Title" ? "" : n.title;
  urlInput.value = n.url;

  saveButton.textContent = "Update Note";
  cancelEditButton.classList.remove("hidden");
  formHeader.textContent = "Edit Note";
}

function resetForm() {
  document.getElementById("note-id").value = "";
  document.getElementById("note-form").reset();
  saveButton.textContent = "Save Note";
  cancelEditButton.classList.add("hidden");
  formHeader.textContent = "Add New Note";
}

async function deleteNote(n) {
  if (!confirm("Delete this note?")) return;

  const local = loadLocalNotes().filter(
    (x) => !(x.local_id === n.local_id || x.id === n.id)
  );
  saveLocalNotes(local);
  allNotes = local;
  renderNotes();

  if (n.id && db && userId) {
    try {
      await colRef(userId).doc(n.id).delete();
    } catch {
      const q = loadSyncQueue();
      q.push({ action: "delete", remoteId: n.id });
      saveSyncQueue(q);
    }
  }
}

/* ============================================================
   AI TITLE BUTTON (simple heuristic)
============================================================ */
aiButton.addEventListener("click", () => {
  const u = urlInput.value.trim();
  if (!u) return displayMessage("Enter a URL first.", "error");

  try {
    const parsed = new URL(u);
    let t =
      parsed.hostname.replace("www.", "") +
      " ‚Äî " +
      (parsed.pathname === "/"
        ? "Homepage"
        : parsed.pathname.split("/").pop().replace(/[-_]/g, " "));

    titleInput.value = t.slice(0, 60);
    displayMessage("AI title suggested.", "success");
  } catch {
    displayMessage("Invalid URL.", "error");
  }
});

/* ============================================================
   MESSAGE TOAST
============================================================ */
function displayMessage(msg, type = "success") {
  const el = document.getElementById("form-message");
  el.textContent = msg;

  el.className =
    "text-sm mt-2 " +
    (type === "success"
      ? "text-green-500"
      : type === "info"
      ? "text-blue-400"
      : "text-red-500");

  setTimeout(() => {
    el.textContent = "";
  }, 3000);
}

/* ============================================================
   STARTUP
============================================================ */
document.getElementById("note-form").addEventListener("submit", saveNote);
cancelEditButton.onclick = resetForm;
filterSubject.onchange = renderNotes;
sortBy.onchange = renderNotes;
searchInput.oninput = renderNotes;

/* AUTH + DATA */
async function startApp() {
  allNotes = loadLocalNotes();
  allSubjects = new Set(allNotes.map((n) => n.subject));
  updateSubjectSuggestions();
  updateSubjectFilter();
  renderNotes();

  if (!db) return setIndicator("local");

  try {
    if (initialAuthToken) {
      await auth.signInWithCustomToken(initialAuthToken);
    } else {
      await auth.signInAnonymously();
    }

    userId = auth.currentUser.uid;
    userIdDisplay.textContent = `User ID: ${userId}`;

    await pushQueue(userId);
    setupListener(userId);

    setIndicator("online");
  } catch (e) {
    console.error(e);
    setIndicator("local");
  }
}

window.addEventListener("load", () => {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js");
  }
  startApp();
});

</script>
