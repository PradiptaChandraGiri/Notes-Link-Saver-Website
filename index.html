<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Notes Link Saver</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs (Required for 'Full-Stack' Persistence) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- Tailwind Configuration for Dark Mode & Colors ---
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#818cf8',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better look in dark mode */
        body::-webkit-scrollbar { width: 8px; }
        body.dark::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        body:not(.dark)::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        .form-input {
            @apply w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-primary focus:border-primary placeholder-gray-400 dark:placeholder-gray-500 shadow-sm;
        }
    </style>
</head>
<body class="font-sans bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl lg:text-4xl font-extrabold text-primary dark:text-primary-dark tracking-tight mb-3 sm:mb-0">
                üìö Daily Notes Link Saver
            </h1>
            <div class="flex items-center space-x-4">
                <!-- User ID Display (MANDATORY for multi-user apps) -->
                <p id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 p-2 rounded-full bg-gray-100 dark:bg-gray-800 shadow-inner" title="Your unique ID"></p>
                <button id="theme-toggle" class="p-2 rounded-full text-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150" title="Toggle Theme">üåô</button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Note Form (Left Column) -->
            <div class="lg:col-span-1 p-6 bg-white dark:bg-gray-800 shadow-2xl rounded-xl h-fit sticky top-4">
                <h2 class="text-2xl font-bold mb-5 border-b pb-2 border-gray-200 dark:border-gray-700" id="form-header">Add New Note</h2>
                <form id="note-form" class="space-y-4">
                    <input type="hidden" id="note-id" value="">
                    
                    <div>
                        <label for="subject" class="block text-sm font-medium mb-1">Subject Name <span class="text-red-500">*</span></label>
                        <input type="text" id="subject" list="subject-suggestions" required 
                               class="form-input" placeholder="e.g., Data Structures, Gemini Prompts">
                        <datalist id="subject-suggestions"></datalist>
                    </div>

                    <div>
                        <label for="title" class="block text-sm font-medium mb-1">Note Title (Optional)</label>
                        <input type="text" id="title"
                               class="form-input" placeholder="e.g., Recursion Concept or RAG paper">
                    </div>

                    <div>
                        <label for="url" class="block text-sm font-medium mb-1">Note Link (URL) <span class="text-red-500">*</span></label>
                        <input type="url" id="url" required 
                               class="form-input" placeholder="https://www.example.com/note-link">
                        
                        <!-- GEMINI FEATURE: AI Title Generator Button -->
                        <button type="button" id="ai-insight-button" 
                                class="w-full mt-2 py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-md transform hover:scale-[1.01] active:scale-[0.99] disabled:bg-purple-800 disabled:opacity-70 disabled:cursor-not-allowed">
                            ‚ú® Get AI Title
                        </button>
                        <!-- End GEMINI FEATURE -->

                    </div>
                    
                    <button type="submit" id="save-button" class="w-full py-3 px-4 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg mt-6 transform hover:scale-[1.01] active:scale-[0.99]">
                        üíæ Save Note
                    </button>
                    <button type="button" id="cancel-edit-button" class="hidden w-full py-3 px-4 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 mt-2">
                        Cancel Edit
                    </button>
                    <p id="form-message" class="text-sm text-center mt-3"></p>
                </form>
            </div>

            <!-- Notes Dashboard (Right Column) -->
            <div class="lg:col-span-2">
                <div class="mb-6 p-4 bg-white dark:bg-gray-800 shadow-2xl rounded-xl">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">All Saved Notes</h2>
                    
                    <!-- Filters and Search -->
                    <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mb-4">
                        <div class="flex-grow">
                            <input type="text" id="search-input" placeholder="Search by Subject or Title..."
                                   class="form-input">
                        </div>
                        
                        <div>
                            <select id="filter-subject" 
                                    class="form-input md:w-48">
                                <option value="">All Subjects</option>
                            </select>
                        </div>

                        <div>
                            <select id="sort-by" 
                                    class="form-input md:w-40">
                                <option value="date_desc">Newest First</option>
                                <option value="date_asc">Oldest First</option>
                                <option value="subject_asc">Subject (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="space-y-3">
                    <p id="loading-message" class="text-center py-8 text-gray-500 dark:text-gray-400">Authenticating and loading notes...</p>
                    <p id="no-notes-message" class="text-center py-8 hidden text-lg text-gray-500 dark:text-gray-400">You haven't saved any notes yet. Use the form to get started!</p>
                </div>

            </div>
        </div>

    </div>

    <script type="module">
        // --- FIREBASE INITIALIZATION & AUTHENTICATION (Mandatory Canvas Setup) ---
        // Global variables are provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = '';

        // Initialize Firebase services
        if (Object.keys(firebaseConfig).length > 0) {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);
            auth = firebase.auth(app);
        } else {
            console.error("Firebase configuration is missing.");
            document.getElementById('loading-message').textContent = 'Error: Firebase config missing.';
        }

        const getNotesCollection = () => db.collection(`artifacts/${appId}/users/${userId}/daily_notes`);
        
        // --- GLOBAL STATE & DOM ELEMENTS ---
        let allNotes = [];
        let allSubjects = new Set();
        const form = document.getElementById('note-form');
        const notesList = document.getElementById('notes-list');
        const subjectSuggestions = document.getElementById('subject-suggestions');
        const filterSubject = document.getElementById('filter-subject');
        const sortBy = document.getElementById('sort-by');
        const searchInput = document.getElementById('search-input');
        const saveButton = document.getElementById('save-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const formHeader = document.getElementById('form-header');
        
        // Gemini specific elements
        const titleInput = document.getElementById('title');
        const urlInput = document.getElementById('url');
        const aiButton = document.getElementById('ai-insight-button');

        // CACHING ELEMENTS THAT WERE CAUSING NULL ERRORS
        const loadingMessage = document.getElementById('loading-message');
        const noNotesMessage = document.getElementById('no-notes-message');


        // Simple utility for messages
        const displayMessage = (msg, type = 'success') => {
            const el = document.getElementById('form-message');
            el.textContent = msg;
            el.className = `text-sm text-center mt-3 font-semibold ${type === 'success' ? 'text-green-500 dark:text-green-400' : type === 'info' ? 'text-blue-500 dark:text-blue-400' : 'text-red-500 dark:text-red-400'}`;
            setTimeout(() => el.textContent = '', 5000);
        };

        // --- GEMINI API INTEGRATION: AI Title Generator ---

        const apiKey = ""; // Canvas provides this dynamically if empty

        /**
         * Uses Gemini and Google Search grounding to analyze a URL and suggest a concise title.
         */
        const generateNoteSummary = async () => {
            let url = urlInput.value.trim();

            if (!url) {
                displayMessage('Please enter a URL first to get AI insight.', 'error');
                return;
            }

            aiButton.disabled = true;
            aiButton.innerHTML = '<span class="animate-spin mr-2">‚öôÔ∏è</span> Analyzing...';
            displayMessage('AI is analyzing the content, please wait (up to 15s)...', 'info');

            // 1. Construct the prompt for the LLM
            const userQuery = `Analyze the content of the following URL: ${url}. Provide a very concise, descriptive title (10 words max) and a single-sentence summary (20 words max). Format the output as: TITLE | SUMMARY.`;
            const systemPrompt = "You are an expert AI assistant specialized in quickly analyzing web content (URLs). Your goal is to provide a highly concentrated title and summary based on the linked source. Ensure the title is descriptive and the summary captures the main idea.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Use Google Search grounding to read the URL content
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // 2. Exponential Backoff and API Call
            const MAX_RETRIES = 3;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;
                        continue; // Retry the request
                    }

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    
                    if (text) {
                        // Expected format: TITLE | SUMMARY. We only use the TITLE part.
                        const parts = text.split('|').map(p => p.trim());
                        const suggestedTitle = parts[0];

                        // Update the Title input field
                        titleInput.value = suggestedTitle;
                        displayMessage(`AI generated title: "${suggestedTitle}"`, 'success');
                    } else {
                         displayMessage('AI failed to generate a title. The URL might not be crawlable or is too brief.', 'error');
                    }

                    break; // Exit the loop on success

                } catch (error) {
                    console.error("Gemini API error:", error);
                    if (attempt === MAX_RETRIES - 1) {
                         displayMessage('Failed to connect to the AI service after multiple tries.', 'error');
                    }
                    attempt++;
                }
            }
            
            // 3. Reset button state
            aiButton.disabled = false;
            aiButton.innerHTML = '‚ú® Get AI Title';
        };

        aiButton.addEventListener('click', generateNoteSummary);

        // --- CRUD FUNCTIONS (Simulated API Routes) ---

        /**
         * Create or Update a note (POST /notes or PUT /notes/:id)
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const noteId = document.getElementById('note-id').value;
            const subject = document.getElementById('subject').value.trim();
            const title = document.getElementById('title').value.trim() || 'No Title';
            let url = document.getElementById('url').value.trim();

            if (!subject || !url) {
                displayMessage('Subject and URL are required.', 'error');
                return;
            }

            // Ensure URL starts with http:// or https://
            if (!url.match(/^(http|https):\/\//)) {
                url = 'https://' + url;
            }

            const noteData = {
                subject: subject,
                title: title,
                url: url,
                // Model requirement: id is handled by Firestore
                // Model requirement: created_at is handled by serverTimestamp() or exists on update
            };

            try {
                if (noteId) {
                    // PUT /notes/:id (Update)
                    await getNotesCollection().doc(noteId).update(noteData);
                    displayMessage('Note updated successfully!');
                } else {
                    // POST /notes (Create)
                    noteData.created_at = firebase.firestore.FieldValue.serverTimestamp();
                    await getNotesCollection().add(noteData);
                    displayMessage('Note saved successfully!');
                }
                
                resetForm();
            } catch (error) {
                console.error("Error saving note: ", error);
                displayMessage(`Failed to save note. ${error.message}`, 'error');
            }
        });

        /**
         * Delete a note (DELETE /notes/:id)
         */
        window.deleteNote = async (id) => {
            if (!confirm("Are you sure you want to delete this note?")) return;
            try {
                await getNotesCollection().doc(id).delete();
                displayMessage('Note deleted successfully!');
            } catch (error) {
                console.error("Error deleting note: ", error);
                displayMessage('Failed to delete note.', 'error');
            }
        };

        /**
         * Prepare form for editing
         */
        window.editNote = (id) => {
            const note = allNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('note-id').value = note.id;
            document.getElementById('subject').value = note.subject;
            // Clear title if it's the 'No Title' default
            document.getElementById('title').value = note.title === 'No Title' ? '' : note.title;
            document.getElementById('url').value = note.url;
            
            saveButton.textContent = '‚úÖ Update Note';
            formHeader.textContent = 'Edit Existing Note';
            cancelEditButton.classList.remove('hidden');
            document.getElementById('subject').focus();
        };

        /**
         * Reset the form after save/update/cancel
         */
        const resetForm = () => {
            form.reset();
            document.getElementById('note-id').value = '';
            saveButton.textContent = 'üíæ Save Note';
            formHeader.textContent = 'Add New Note';
            cancelEditButton.classList.add('hidden');
            // Ensure AI button is reset if a save happened while it was running (though unlikely)
            aiButton.disabled = false;
            aiButton.innerHTML = '‚ú® Get AI Title';
        };

        cancelEditButton.addEventListener('click', resetForm);

        // --- DATA FETCHING & RENDERING (GET /notes) ---

        /**
         * Fetches data in real-time and triggers rendering
         */
        const setupNotesListener = () => {
            // Real-time listener: Fetches data, updates on change
            getNotesCollection().onSnapshot(snapshot => {
                loadingMessage.classList.add('hidden'); // Use cached element
                
                allNotes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert Firebase Timestamp to JS Date object
                    created_at: doc.data().created_at ? doc.data().created_at.toDate() : new Date(),
                }));
                
                // Update subjects for filter and suggestions
                allSubjects = new Set(allNotes.map(n => n.subject));
                updateSubjectSuggestions();
                updateSubjectFilter();
                
                renderNotes(); // Trigger rendering of the filtered/sorted view
            }, err => {
                console.error("Error fetching notes: ", err);
                loadingMessage.textContent = 'Error loading notes.'; // Use cached element
                loadingMessage.classList.remove('hidden'); // Use cached element
            });
        };

        /**
         * Renders the current filtered and sorted list of notes
         */
        const renderNotes = () => {
            const filterVal = filterSubject.value;
            const searchVal = searchInput.value.toLowerCase();
            const sortVal = sortBy.value;

            // 1. Filter and Search
            let filteredNotes = allNotes.filter(note => {
                const subjectMatch = filterVal === '' || note.subject === filterVal;
                const searchMatch = !searchVal || 
                                    note.subject.toLowerCase().includes(searchVal) || 
                                    note.title.toLowerCase().includes(searchVal);
                return subjectMatch && searchMatch;
            });

            // 2. Sort
            filteredNotes.sort((a, b) => {
                if (sortVal === 'subject_asc') return a.subject.localeCompare(b.subject);
                
                // Date sort
                const dateA = a.created_at.getTime();
                const dateB = b.created_at.getTime();
                return sortVal === 'date_asc' ? dateA - dateB : dateB - dateA; // date_desc is default (Newest First)
            });

            // 3. Render
            notesList.innerHTML = '';
            if (filteredNotes.length === 0) {
                noNotesMessage.classList.remove('hidden'); // Use cached element
                return;
            }
            noNotesMessage.classList.add('hidden'); // Use cached element

            filteredNotes.forEach(note => {
                notesList.innerHTML += `
                    <div class="note-card p-4 bg-white dark:bg-gray-800 shadow-xl rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center border-l-4 border-primary dark:border-primary-dark hover:shadow-2xl transition duration-200">
                        <!-- Note Info -->
                        <div class="flex-grow min-w-0 mb-3 md:mb-0">
                            <span class="inline-block text-xs font-semibold px-2 py-0.5 rounded-full bg-primary/10 text-primary dark:bg-primary-dark/20 dark:text-primary-dark">${note.subject}</span>
                            <p class="text-lg font-bold truncate mt-1">
                                <a href="${note.url}" target="_blank" rel="noopener noreferrer" class="hover:text-primary dark:hover:text-primary-dark transition duration-150 break-all" title="Go to Note: ${note.title}">
                                    ${note.title}
                                </a>
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                                Saved: ${note.created_at.toLocaleDateString()} ${note.created_at.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2 flex-shrink-0">
                            <button onclick="editNote('${note.id}')" class="p-2 text-base text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-200 transition duration-150 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Edit Note">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteNote('${note.id}')" class="p-2 text-base text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 transition duration-150 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Delete Note">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
        };

        // --- EXTRA FEATURES (Filters, Suggestions, Dark Mode) ---

        /**
         * Update subject dropdown for filtering
         */
        const updateSubjectFilter = () => {
            const currentFilter = filterSubject.value;
            filterSubject.innerHTML = '<option value="">All Subjects</option>';
            [...allSubjects].sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                filterSubject.appendChild(option);
            });
            filterSubject.value = currentFilter;
        };

        /**
         * Update datalist for auto-suggest in the form
         */
        const updateSubjectSuggestions = () => {
            subjectSuggestions.innerHTML = '';
            [...allSubjects].sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                subjectSuggestions.appendChild(option);
            });
        };

        // Add listeners for filtering, sorting, and searching
        filterSubject.addEventListener('change', renderNotes);
        sortBy.addEventListener('change', renderNotes);
        searchInput.addEventListener('input', renderNotes);

        /**
         * Dark Mode Toggle
         */
        const themeToggle = document.getElementById('theme-toggle');
        const toggleTheme = () => {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.textContent = isDark ? 'üí°' : 'üåô';
        };

        // Initialize theme from local storage
        const initTheme = () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
                themeToggle.textContent = 'üí°';
            } else {
                themeToggle.textContent = 'üåô';
            }
        };

        themeToggle.addEventListener('click', toggleTheme);
        initTheme();

        // --- INITIALIZATION ---
        const setupAuth = async () => {
            try {
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }
                userId = auth.currentUser.uid;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                setupNotesListener();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.getElementById('loading-message').textContent = 'Error: Authentication failed.';
            }
        };

        window.onload = () => {
            if (db) {
                setupAuth();
            }
        };

    </script>
</body>
</html>
